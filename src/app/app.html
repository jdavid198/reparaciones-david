<app-toast></app-toast>
<div class="container">

  <div class="form-header">
    <img src="/logo.png" alt="Logo" class="logo" />
    <div class="titulo">
      <h1>Reparaciones</h1>
    </div>
  </div>

  <form [formGroup]="form" (ngSubmit)="registrar()">
    <div class="form-grid-3">

      <!-- Columna 1: Datos del Cliente -->
      <div class="columna">
        <h3>Datos del Cliente</h3>

        <div class="campo">
          <label>Fecha Ingreso</label>
          <input type="date" formControlName="fechaIngreso" readonly />
        </div>

        <div class="campo">
          <label>Nombre del Cliente</label>
          <input type="text" formControlName="nombre" placeholder="Nombre completo" />
        </div>

        <div class="campo">
          <label>Tel√©fono</label>
          <input type="tel" formControlName="telefono" placeholder="Ej: 3001234567" maxlength="10" inputmode="numeric"
            (input)="validarInputTelefono($event)" />
        </div>
      </div>

      <!-- Columna 2: Datos de los Art√≠culos -->
      <div class="columna">
        <h3>Datos de los Art√≠culos</h3>

        <div class="campo">
          <label>Cantidad de art√≠culos</label>
          <input type="number" formControlName="cantidad" placeholder="Ej: 2" min="1" />
          <div class="error" *ngIf="form.get('cantidad')?.errors?.['min']">
          </div>
        </div>

        <div class="campo descripcion">
          <label>Descripci√≥n</label>
          <textarea formControlName="descripcion" placeholder="Detalle del trabajo, art√≠culo o da√±o a reparar..."
            maxlength="150"></textarea>
        </div>

        <div class="campo">
          <label>C√≥digo de Reclamaci√≥n</label>
          <input type="text" formControlName="codigoReclamacion" placeholder="Ej: ABC123" />
        </div>
      </div>

      <!-- Columna 3: Valores -->
      <div class="columna">
        <h3>Valores</h3>

        <div class="campo">
          <label>Valor del Trabajo</label>
          <input type="text" formControlName="valorTrabajo" (input)="formatearMoneda('valorTrabajo')"
            placeholder="$ 0" />
        </div>

        <div class="campo">
          <label>Abono</label>
          <input type="text" formControlName="abono" (input)="formatearMoneda('abono')" placeholder="$ 0" />
        </div>

        <div class="campo">
          <label>Saldo</label>
          <input type="text" formControlName="saldo" readonly />
        </div>
      </div>
    </div>

    <!-- Botones -->
    <div class="botones">
      <button type="submit">Registrar</button>
      <button type="button" (click)="exportarExcel()">Exportar a Excel</button>
    </div>
  </form>


  <!-- Filtro de b√∫squeda -->
  <div class="filtro-container">
    <div class="filtro-input-group">
      <input type="text" [(ngModel)]="filtroTexto" (keydown.enter)="buscar()"
        placeholder="üîç Buscar por c√≥digo de reclamaci√≥n o tel√©fono..." class="filtro-input"
        [disabled]="filtrandoEnFirebase">
      <button (click)="buscar()" class="btn-buscar" type="button" title="Buscar" [disabled]="filtrandoEnFirebase">
        <span *ngIf="!filtrandoEnFirebase">üîç</span>
        <span *ngIf="filtrandoEnFirebase">‚è≥</span>
      </button>
      <button *ngIf="filtroTexto.trim() || hayFiltroActivo" (click)="limpiarFiltro()" class="btn-limpiar" type="button"
        title="Limpiar filtro">
        ‚úï
      </button>
    </div>
    <small class="contador">
      <span *ngIf="filtrandoEnFirebase" class="buscando">üîÑ Buscando...</span>
      <span *ngIf="!filtrandoEnFirebase">
        Mostrando {{ reparacionesFiltradas.length }} registros
        <span *ngIf="hayFiltroActivo">(filtrados por "{{ filtroAplicado }}")</span>
      </span>
    </small>
  </div>

  <table>
    <thead>
      <tr>
        <th>Fecha Ingreso</th>
        <th>Cliente</th>
        <th>Tel√©fono</th>
        <th>Cantidad</th>
        <th>Descripci√≥n</th>
        <th>Valor</th>
        <th>Abono</th>
        <th>Saldo</th>
        <th>C√≥digo</th>
        <th>Estado</th>
        <th>Fecha Finalizaci√≥n</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let rep of reparacionesFiltradas" [class]="getEstadoClass(rep.estado)">
        <td>{{ rep.fechaIngreso }}</td>
        <td><strong>{{ rep.nombre }}</strong></td>
        <td>{{ rep.telefono }}</td>
        <td>{{ rep.cantidad }}</td>
        <td>{{ rep.descripcion }}</td>
        <td>{{ rep.valorTrabajo | currency:'COP':'symbol':'1.0-0' }}</td>
        <td>{{ rep.abono | currency:'COP':'symbol':'1.0-0' }}</td>
        <td>{{ rep.saldo | currency:'COP':'symbol':'1.0-0' }}</td>
        <td><strong>{{ rep.codigoReclamacion }}</strong></td>
        <td>
          <span class="estado-badge" [class]="'badge-' + rep.estado">
            {{ rep.estado | titlecase }}
          </span>
        </td>
        <td class="fecha-finalizacion">
          <span *ngIf="rep.fechaFinalizacion" class="fecha-texto">
            {{ formatearFecha(rep.fechaFinalizacion) }}
          </span>
          <span *ngIf="!rep.fechaFinalizacion" class="sin-fecha">-</span>
        </td>
        <td class="acciones">
          <button *ngIf="rep.estado !== 'entregada'" class="btn-entregar" (click)="cambiarEstado(rep.id!, 'entregada')"
            title="Marcar como entregada">
            ‚úì Entregar
          </button>
          <button *ngIf="rep.estado !== 'cancelada'" class="btn-cancelar" (click)="cambiarEstado(rep.id!, 'cancelada')"
            title="Marcar como cancelada">
            ‚úó Cancelar
          </button>
          <button *ngIf="rep.estado !== 'pendiente'" class="btn-pendiente" (click)="cambiarEstado(rep.id!, 'pendiente')"
            title="Marcar como pendiente">
            ‚è≥ Pendiente
          </button>
          <button class="btn-editar" (click)="editarReparacion(rep)" title="Editar reparaci√≥n">
            ‚úé Editar
          </button>
        </td>
      </tr>
    </tbody>
  </table>

<!-- Modal Editar Reparaci√≥n -->
<div class="modal-backdrop" *ngIf="modalEditarVisible">
  <div class="modal">
    <h2>Editar reparaci√≥n</h2>

    <form [formGroup]="formEditar" (ngSubmit)="guardarEdicion()">

      <!-- Solo lectura -->
      <label>
        Cliente:
        <input formControlName="nombre" readonly />
      </label>

      <label>
        Tel√©fono:
        <input formControlName="telefono" readonly />
      </label>

      <label>
        Fecha Ingreso:
        <input formControlName="fechaIngreso" readonly />
      </label>

      <label>
        Valor del Trabajo:
        <input type="number" formControlName="valorTrabajo" readonly />
      </label>

      <label>
        Saldo:
        <input type="number" formControlName="saldo" readonly />
      </label>

      <!-- Campos editables -->
      <label>
        Descripci√≥n:
        <textarea formControlName="descripcion" maxlength="150"></textarea>
      </label>

      <label>
        Abono:
        <input type="number" formControlName="abono" />
      </label>

      <label>
        Cantidad de art√≠culos:
        <input type="number" formControlName="cantidad" />
      </label>

      <!-- Botones -->
      <div class="modal-actions">
        <button type="submit" class="btn-guardar">üíæ Guardar</button>
        <button type="button" class="btn-cancelar" (click)="cerrarModal()">‚úñ Cancelar</button>
      </div>
    </form>
  </div>
</div>


</div>


